name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verificar arquivos
        run: |
          echo "üìÅ Arquivos no projeto:"
          ls -la
          echo ""
          echo "üì¶ package.json:"
          cat package.json
      
      - name: Instalar depend√™ncias
        run: |
          echo "üì• Instalando depend√™ncias..."
          npm install
          echo "‚úÖ Depend√™ncias instaladas"
      
      - name: Build aplica√ß√£o web
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://asouobyyuxsiemlppjlj.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzb3VvYnl5dXhzaWVtbHBwamxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzg3NzYsImV4cCI6MjA3OTc1NDc3Nn0.CN-50KUWEzYGD-RJqe_n1U9JD1GDYVU6QaRyia1R4n0' }}
      
      - name: Verificar build
        run: |
          echo "üì¶ Verificando build:"
          ls -la dist/
      
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Sincronizar Capacitor
        run: npx cap sync android
      
      - name: Build APK com Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30
