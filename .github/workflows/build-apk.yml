name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Listar arquivos do projeto
        run: |
          echo "ðŸ“ Estrutura do projeto:"
          ls -la
          echo ""
          echo "ðŸ“¦ ConteÃºdo do package.json:"
          cat package.json | head -30
          echo ""
          echo "ðŸ¤– Verificando pasta android:"
          ls -la android/ | head -20
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Limpar cache npm
        run: npm cache clean --force
      
      - name: Instalar dependÃªncias (com verbose)
        run: |
          echo "ðŸ“¥ Instalando dependÃªncias..."
          npm install --verbose 2>&1 | tail -50
          echo ""
          echo "âœ… InstalaÃ§Ã£o concluÃ­da!"
          echo ""
          echo "ðŸ“¦ Verificando node_modules:"
          ls -la node_modules/@capacitor/ 2>&1 || echo "âŒ @capacitor nÃ£o encontrado"
      
      - name: Build aplicaÃ§Ã£o web
        run: |
          echo "ðŸ”¨ Buildando aplicaÃ§Ã£o..."
          npx vite build
        env:
          VITE_SUPABASE_URL: https://asouobyyuxsiemlppjlj.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzb3VvYnl5dXhzaWVtbHBwamxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzg3NzYsImV4cCI6MjA3OTc1NDc3Nn0.CN-50KUWEzYGD-RJqe_n1U9JD1GDYVU6QaRyia1R4n0
      
      - name: Verificar build
        run: |
          echo "ðŸ“¦ Arquivos gerados:"
          ls -la dist/
          du -sh dist/
      
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Verificar Java
        run: |
          java -version
          echo "JAVA_HOME: $JAVA_HOME"
      
      - name: Sincronizar Capacitor
        run: |
          echo "ðŸ”„ Sincronizando Capacitor..."
          npx cap sync android --verbose
      
      - name: Verificar arquivos Android
        run: |
          echo "ðŸ“± Estrutura android/:"
          ls -la android/
          echo ""
          echo "ðŸ”§ Verificando gradlew:"
          ls -la android/gradlew
          file android/gradlew
      
      - name: Build APK com Gradle
        run: |
          cd android
          echo "ðŸ”¨ Dando permissÃ£o ao gradlew..."
          chmod +x gradlew
          echo "ðŸ”¨ Buildando APK..."
          ./gradlew assembleRelease --no-daemon --stacktrace 2>&1 | tail -100
      
      - name: Verificar APK gerado
        run: |
          echo "ðŸ“¦ Procurando APK:"
          find android -name "*.apk" -type f
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
